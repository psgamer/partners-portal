rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      // refuse all unspecified by default
      allow read, write: if false;
    }

  	function isAuthorized() {
      return request.auth.uid != null;
    }
  	function currentDoc() {
      return resource.data;
    }
  	function futureDoc() {
      return request.resource.data;
    }
  	function diffMap() {
      return futureDoc().diff(currentDoc());
    }

    match /clients/{clientId} {
    	allow read: if isAuthorized() && request.auth.token.contractorId in currentDoc().contractorIds;
    }
    match /local-solutions/{localSolutionId} {
    	allow read: if isAuthorized();
    }
    match /order-amount-ranges/{rangeId} {
    	allow read: if true;
    }
    match /contractors/{contractorId} {
      function isCurrentUserContractor() {
        return isAuthorized() && request.auth.token.contractorId == contractorId;
      }
      function isCurrentUserContractorsDistributor() {
        return isAuthorized() && request.auth.token.contractorId in currentDoc().contractorIds;
      }

      allow read: if isAuthorized() && (isCurrentUserContractor() || isCurrentUserContractorsDistributor());

      match /payers/{payerId} {
        function isCurrentUserPayerContractorsDistributor() {
          return isAuthorized() && request.auth.token.contractorId in get(/databases/$(database)/documents/contractors/$(contractorId)).data.contractorIds;// TODO refactor to avoid requests?
        }

      	allow read: if isAuthorized() && (isCurrentUserContractor() || isCurrentUserPayerContractorsDistributor());
      }
      match /orders/{orderId} {
        function isValidCancelOperation() {
          return diffMap().affectedKeys().hasOnly(['status'])
            && futureDoc().status == 'CANCELLED'
            && currentDoc().status in ['NEW', 'PENDING'];
        }
        function isValidDeleteOperation() {
          return currentDoc().status == 'NEW';
        }
        function isValidCreateOperation() {
          return false;
        }
        function isValidUpdateOperation() {
          return false;
        }

      	allow read: if isAuthorized() && isCurrentUserContractor();
        allow create: if isAuthorized() && isCurrentUserContractor() && isValidCreateOperation();
        allow update: if isAuthorized() && isCurrentUserContractor() && (isValidCancelOperation() || isValidUpdateOperation());
        allow delete: if isAuthorized() && isCurrentUserContractor() && isValidDeleteOperation();
      }
    }
  }
}
